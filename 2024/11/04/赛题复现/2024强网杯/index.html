<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/0.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/0.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/0.jpg">
  <link rel="mask-icon" href="/images/0.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dexterjie.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="记录2024强网杯Crypto部分题解">
<meta property="og:type" content="article">
<meta property="og:title" content="2024强网杯">
<meta property="og:url" content="https://dexterjie.github.io/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/index.html">
<meta property="og:site_name" content="DexterJie&#39;Blog">
<meta property="og:description" content="记录2024强网杯Crypto部分题解">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dexterjie.github.io/images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/1.png">
<meta property="og:image" content="https://dexterjie.github.io/images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-2-1.png">
<meta property="og:image" content="https://dexterjie.github.io/images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-1.png">
<meta property="og:image" content="https://dexterjie.github.io/images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-2.png">
<meta property="og:image" content="https://dexterjie.github.io/images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-4.png">
<meta property="og:image" content="https://dexterjie.github.io/images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-3.png">
<meta property="article:published_time" content="2024-11-04T02:25:01.000Z">
<meta property="article:modified_time" content="2024-11-04T07:57:08.712Z">
<meta property="article:author" content="DexterJie">
<meta property="article:tag" content="Wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dexterjie.github.io/images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/1.png">


<link rel="canonical" href="https://dexterjie.github.io/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://dexterjie.github.io/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/","path":"2024/11/04/赛题复现/2024强网杯/","title":"2024强网杯"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>2024强网杯 | DexterJie'Blog</title>
  







<link rel="dns-prefetch" href="waline-five-mocha.vercel.app">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">DexterJie'Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Never Mind the Scandal and Liber!!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1456890009&auto=1&height=66"></iframe>
    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#easyRSA"><span class="nav-number">1.</span> <span class="nav-text">easyRSA</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#apbq"><span class="nav-number">2.</span> <span class="nav-text">apbq</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#stage1"><span class="nav-number">2.1.</span> <span class="nav-text">stage1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stage2"><span class="nav-number">2.2.</span> <span class="nav-text">stage2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stage3%E2%80%94%E2%80%94unsolved"><span class="nav-number">2.3.</span> <span class="nav-text">stage3——unsolved</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#21-steps"><span class="nav-number">3.</span> <span class="nav-text">21_steps</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#traditional-game"><span class="nav-number">4.</span> <span class="nav-text">traditional_game</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#step1"><span class="nav-number">4.1.</span> <span class="nav-text">step1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step2"><span class="nav-number">4.2.</span> <span class="nav-text">step2</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="DexterJie"
      src="/images/0.jpg">
  <p class="site-author-name" itemprop="name">DexterJie</p>
  <div class="site-description" itemprop="description">一枚只会Crypto的菜鸡</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">75</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dexterjie.github.io/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/0.jpg">
      <meta itemprop="name" content="DexterJie">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DexterJie'Blog">
      <meta itemprop="description" content="一枚只会Crypto的菜鸡">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="2024强网杯 | DexterJie'Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2024强网杯
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-11-04 10:25:01 / 修改时间：15:57:08" itemprop="dateCreated datePublished" datetime="2024-11-04T10:25:01+08:00">2024-11-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Wp/" itemprop="url" rel="index"><span itemprop="name">Wp</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>记录2024强网杯Crypto部分题解</p>
<span id="more"></span>

<p><img src="/../../images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/1.png"></p>
<p>结束前1小时做出高分题，win!</p>
<h1 id="easyRSA"><a href="#easyRSA" class="headerlink" title="easyRSA"></a>easyRSA</h1><blockquote>
<p>task.py</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes, bytes_to_long, getPrime</span><br><span class="line"><span class="keyword">import</span> random, gmpy2</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RSAEncryptor</span>:</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">		self.g = self.a = self.b = <span class="number">0</span></span><br><span class="line">		self.e = <span class="number">65537</span></span><br><span class="line">		self.factorGen()</span><br><span class="line">		self.product()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">factorGen</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			self.g = getPrime(<span class="number">500</span>)</span><br><span class="line">			<span class="keyword">while</span> <span class="keyword">not</span> gmpy2.is_prime(<span class="number">2</span>*self.g*self.a+<span class="number">1</span>):</span><br><span class="line">				self.a = random.randint(<span class="number">2</span>**<span class="number">523</span>, <span class="number">2</span>**<span class="number">524</span>)</span><br><span class="line">			<span class="keyword">while</span> <span class="keyword">not</span> gmpy2.is_prime(<span class="number">2</span>*self.g*self.b+<span class="number">1</span>):</span><br><span class="line">				self.b = random.randint(<span class="number">2</span>**<span class="number">523</span>, <span class="number">2</span>**<span class="number">524</span>)</span><br><span class="line">			self.h = <span class="number">2</span>*self.g*self.a*self.b+self.a+self.b</span><br><span class="line">			<span class="keyword">if</span> gmpy2.is_prime(self.h):</span><br><span class="line">				self.N = <span class="number">2</span>*self.h*self.g+<span class="number">1</span></span><br><span class="line">				<span class="built_in">print</span>(<span class="built_in">len</span>(<span class="built_in">bin</span>(self.N)))</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self, msg</span>):</span><br><span class="line">		<span class="keyword">return</span> gmpy2.powmod(msg, self.e, self.N)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">product</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">			self.flag = f.read()</span><br><span class="line">		self.enc = self.encrypt(self.flag)</span><br><span class="line">		self.show()</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">f&#x27;enc=<span class="subst">&#123;self.enc&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">f&quot;N=<span class="subst">&#123;self.N&#125;</span>&quot;</span>)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">f&quot;e=<span class="subst">&#123;self.e&#125;</span>&quot;</span>)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">f&quot;g=<span class="subst">&#123;self.g&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RSAEncryptor()</span><br></pre></td></tr></table></figure>

<p>根据p,q的产生方式</p>
<p>定位到Common Prime RSA。<a target="_blank" rel="noopener" href="https://hasegawaazusa.github.io/common-prime-rsa.html?highlight=common+prime">Common Prime RSA 笔记 | 独奏の小屋</a>找到该题符合的条件：g &lt; a + b，即1.3.3中的攻击脚本</p>
<p><img src="/../../images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-2-1.png"></p>
<p>先获取数据，N是2048bit，g是500bit。更改参数，把nbits改成2048,gamma改为0.244</p>
<blockquote>
<p>exp</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.groups.generic <span class="keyword">import</span> bsgs</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">N=<span class="number">20435271199198608366445070163055743926530547854315033141279645965767638473864664330754962276436466649275050979103893712139245544544872935554374114399052839215948338405516499474115214273699914266370050930769132408706474824505336493869342787492685168436693712862639462238101469809198476436457638629311139852354706756281766432512479057195404236230484898324707597749019917227269367587815080448139295679716499335061655279345030131435571625512494222844856455878041228974934679176701090200039100574296646644271325056802850586021423090540681108392177561696676096831318357211402247645340390966411768743795331989322314544746799</span></span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">g=<span class="number">1782714261471199600627912602675948124521242155026857581417496643395108146067670647314507299724027644449584417991370237640807949819393846820875335817261</span></span><br><span class="line">enc=<span class="number">20350664281726403319264794434818308682046627973818456992245939179105629755654804516474027208643477028915373806837243260505684415739400790158679693158292815111799557125205151404100645653607777497253093260710715998875446908652240009553176151050618425031785922700834263127349910566138042780128833737173370642149352579347648172805592085834236458809040063106208561153446872735282875495007579182595935084451653408565873131518763369654422924777264084722832367604444283493236654780236432466093893715601405666605776325094892405077833019846528616538992220553807641215435015982473851848348382653049398621386187791517991659737573</span></span><br><span class="line">nbits = <span class="number">2048</span></span><br><span class="line">gamma = <span class="number">0.244</span></span><br><span class="line">cbits = ceil(nbits * (<span class="number">0.5</span> - <span class="number">2</span> * gamma))</span><br><span class="line"></span><br><span class="line">M = (N - <span class="number">1</span>) // (<span class="number">2</span> * g)</span><br><span class="line">u = M // (<span class="number">2</span> * g)</span><br><span class="line">v = M - <span class="number">2</span> * g * u</span><br><span class="line">GF = Zmod(N)</span><br><span class="line">x = GF.random_element()</span><br><span class="line">y = x ^ (<span class="number">2</span> * g)</span><br><span class="line"><span class="comment"># c的范围大概与N^(0.5-2*gamma)很接近</span></span><br><span class="line">c = bsgs(y, y ^ u, ((<span class="number">2</span>**(cbits-<span class="number">1</span>)), (<span class="number">2</span>**(cbits+<span class="number">1</span>))))</span><br><span class="line">ab = u - c</span><br><span class="line">apb = v + <span class="number">2</span> * g * c</span><br><span class="line">P.&lt;x&gt; = ZZ[]</span><br><span class="line">f = x ^ <span class="number">2</span> - apb * x + ab</span><br><span class="line">a = f.roots()</span><br><span class="line"><span class="keyword">if</span> a:</span><br><span class="line">    a, b = a[<span class="number">0</span>][<span class="number">0</span>], a[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">    p = <span class="number">2</span> * g * a + <span class="number">1</span></span><br><span class="line">    q = <span class="number">2</span> * g * b + <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> p * q == N</span><br><span class="line"></span><br><span class="line">d = inverse(e,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line">m = <span class="built_in">pow</span>(enc,d,N)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br><span class="line"><span class="comment"># flag&#123;927ab370-fd1e-422d-8658-60b16447c86e&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="apbq"><a href="#apbq" class="headerlink" title="apbq"></a>apbq</h1><blockquote>
<p>task.py</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secrets <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> ceil</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RSA</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, privatekey, publickey</span>):</span><br><span class="line">        self.p, self.q, self.d = privatekey</span><br><span class="line">        self.n, self.e = publickey</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self, plaintext</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(plaintext, <span class="built_in">bytes</span>):</span><br><span class="line">            plaintext = bytes_to_long(plaintext)</span><br><span class="line">        ciphertext = <span class="built_in">pow</span>(plaintext, self.e, self.n)</span><br><span class="line">        <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">self, ciphertext</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(ciphertext, <span class="built_in">bytes</span>):</span><br><span class="line">            ciphertext = bytes_to_long(ciphertext)</span><br><span class="line">        plaintext = <span class="built_in">pow</span>(ciphertext, self.d, self.n)</span><br><span class="line">        <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_keypair</span>(<span class="params">nbits, e = <span class="number">65537</span></span>):</span><br><span class="line">    p = getPrime(nbits//<span class="number">2</span>)</span><br><span class="line">    q = getPrime(nbits//<span class="number">2</span>)</span><br><span class="line">    n = p * q</span><br><span class="line">    d = inverse(e, n - p - q + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> (p, q, d), (n, e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pt = <span class="string">&#x27;./output.txt&#x27;</span></span><br><span class="line">    fout = <span class="built_in">open</span>(pt, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    sys.stdout = fout</span><br><span class="line"></span><br><span class="line">    block_size = ceil(<span class="built_in">len</span>(flag)/<span class="number">3</span>)</span><br><span class="line">    flag = [flag[i:i+block_size] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(flag), block_size)]</span><br><span class="line">    e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+] Welcome to my apbq game&#x27;</span>)</span><br><span class="line">    <span class="comment"># stage 1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ stage 1: p + q&#x27;</span>)</span><br><span class="line">    prikey1, pubkey1 = get_keypair(<span class="number">1024</span>)</span><br><span class="line">    RSA1 = RSA(prikey1, pubkey1)</span><br><span class="line">    enc1 = RSA1.encrypt(flag[<span class="number">0</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ hints = <span class="subst">&#123;prikey1[<span class="number">0</span>] + prikey1[<span class="number">1</span>]&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ public key = <span class="subst">&#123;pubkey1&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ enc1 = <span class="subst">&#123;enc1&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;----------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># stage 2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ stage 2: ai*p + bi*q&#x27;</span>)</span><br><span class="line">    prikey2, pubkey2 = get_keypair(<span class="number">1024</span>)</span><br><span class="line">    RSA2 = RSA(prikey2, pubkey2)</span><br><span class="line">    enc2 = RSA2.encrypt(flag[<span class="number">1</span>])</span><br><span class="line">    kbits = <span class="number">180</span></span><br><span class="line">    a = [getRandomNBitInteger(kbits) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>)]</span><br><span class="line">    b = [getRandomNBitInteger(kbits) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>)]</span><br><span class="line">    c = [a[i]*prikey2[<span class="number">0</span>] + b[i]*prikey2[<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ hints = <span class="subst">&#123;c&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ public key = <span class="subst">&#123;pubkey2&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ enc2 = <span class="subst">&#123;enc2&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;----------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># stage 3</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ stage 3: a*p + q, p + bq&#x27;</span>)</span><br><span class="line">    prikey3, pubkey3 = get_keypair(<span class="number">1024</span>)</span><br><span class="line">    RSA3 = RSA(prikey3, pubkey3)</span><br><span class="line">    enc3 = RSA2.encrypt(flag[<span class="number">2</span>])</span><br><span class="line">    kbits = <span class="number">512</span></span><br><span class="line">    a = getRandomNBitInteger(kbits)</span><br><span class="line">    b = getRandomNBitInteger(kbits)</span><br><span class="line">    c1 = a*prikey3[<span class="number">0</span>] + prikey3[<span class="number">1</span>]</span><br><span class="line">    c2 = prikey3[<span class="number">0</span>] + b*prikey3[<span class="number">1</span>] </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ hints = <span class="subst">&#123;c1, c2&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ public key = <span class="subst">&#123;pubkey3&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;┃ enc3 = <span class="subst">&#123;enc3&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>output.txt</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[+] Welcome to my apbq game</span><br><span class="line">┃ stage 1: p + q</span><br><span class="line">┃ hints = 18978581186415161964839647137704633944599150543420658500585655372831779670338724440572792208984183863860898382564328183868786589851370156024615630835636170</span><br><span class="line">┃ public key = (89839084450618055007900277736741312641844770591346432583302975236097465068572445589385798822593889266430563039645335037061240101688433078717811590377686465973797658355984717210228739793741484666628342039127345855467748247485016133560729063901396973783754780048949709195334690395217112330585431653872523325589, 65537)</span><br><span class="line">┃ enc1 = 23664702267463524872340419776983638860234156620934868573173546937679196743146691156369928738109129704387312263842088573122121751421709842579634121187349747424486233111885687289480494785285701709040663052248336541918235910988178207506008430080621354232140617853327942136965075461701008744432418773880574136247</span><br><span class="line">----------------------</span><br><span class="line">┃ stage 2: ai*p + bi*q</span><br><span class="line">┃ hints = []</span><br><span class="line">┃ public key = (73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819, 65537)</span><br><span class="line">┃ enc2 = 30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span><br><span class="line">----------------------</span><br><span class="line">┃ stage 3: a*p + q, p + bq</span><br><span class="line">┃ hints = (68510878638370415044742935889020774276546916983689799210290582093686515377232591362560941306242501220803210859757512468762736941602749345887425082831572206675493389611203432014126644550502117937044804472954180498370676609819898980996282130652627551615825721459553747074503843556784456297882411861526590080037, 117882651978564762717266768251008799169262849451887398128580060795377656792158234083843539818050019451797822782621312362313232759168181582387488893534974006037142066091872636582259199644094998729866484138566711846974126209431468102938252566414322631620261045488855395390985797791782549179665864885691057222752)</span><br><span class="line">┃ public key = (94789409892878223843496496113047481402435455468813255092840207010463661854593919772268992045955100688692872116996741724352837555794276141314552518390800907711192442516993891316013640874154318671978150702691578926912235318405120588096104222702992868492960182477857526176600665556671704106974346372234964363581, 65537)</span><br><span class="line">┃ enc3 = 17737974772490835017139672507261082238806983528533357501033270577311227414618940490226102450232473366793815933753927943027643033829459416623683596533955075569578787574561297243060958714055785089716571943663350360324047532058597960949979894090400134473940587235634842078030727691627400903239810993936770281755</span><br></pre></td></tr></table></figure>



<h2 id="stage1"><a href="#stage1" class="headerlink" title="stage1"></a>stage1</h2><p>给出$h &#x3D; p+q$，联立$n &#x3D; p\times q$就能分解了</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">hints = <span class="number">18978581186415161964839647137704633944599150543420658500585655372831779670338724440572792208984183863860898382564328183868786589851370156024615630835636170</span></span><br><span class="line">n1,e1 = (<span class="number">89839084450618055007900277736741312641844770591346432583302975236097465068572445589385798822593889266430563039645335037061240101688433078717811590377686465973797658355984717210228739793741484666628342039127345855467748247485016133560729063901396973783754780048949709195334690395217112330585431653872523325589</span>, <span class="number">65537</span>)</span><br><span class="line">enc1 = <span class="number">23664702267463524872340419776983638860234156620934868573173546937679196743146691156369928738109129704387312263842088573122121751421709842579634121187349747424486233111885687289480494785285701709040663052248336541918235910988178207506008430080621354232140617853327942136965075461701008744432418773880574136247</span></span><br><span class="line"></span><br><span class="line">p_add_q = hints</span><br><span class="line">p_sub_q = gmpy2.iroot(p_add_q^<span class="number">2</span> - <span class="number">4</span>*n1,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">p1 = (p_add_q + p_sub_q) // <span class="number">2</span></span><br><span class="line">q1 = (p_add_q - p_sub_q) // <span class="number">2</span></span><br><span class="line">d1 = inverse(e1,(p1-<span class="number">1</span>)*(q1-<span class="number">1</span>))</span><br><span class="line">m1 = <span class="built_in">pow</span>(enc1,d1,n1)</span><br><span class="line">flag1 = long_to_bytes(m1)</span><br><span class="line"><span class="built_in">print</span>(flag1)</span><br><span class="line"><span class="comment"># flag&#123;yOu_can_</span></span><br></pre></td></tr></table></figure>

<h2 id="stage2"><a href="#stage2" class="headerlink" title="stage2"></a>stage2</h2><p>第二部分类似于DownUnderCTF2023的ap+bq-ii。今年华为杯也有这题。找到这个exp：<a target="_blank" rel="noopener" href="https://github.com/josephsurin/my-ctf-challenges/blob/main/downunderctf-2023/apbq-rsa-ii/solve/solv.sage">my-ctf-challenges&#x2F;downunderctf-2023&#x2F;apbq-rsa-ii&#x2F;solve&#x2F;solv.sage at main · josephsurin&#x2F;my-ctf-challenges</a></p>
<p>拿原有的exp打了一下发现没打出来，试过爆破一些高位，但无果，后面索性多用些数据，没想到4个数据就分解了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># n, c, hints</span></span><br><span class="line">hints = []</span><br><span class="line">n, e = (<span class="number">73566307488763122580179867626252642940955298748752818919017828624963832700766915409125057515624347299603944790342215380220728964393071261454143348878369192979087090394858108255421841966688982884778999786076287493231499536762158941790933738200959195185310223268630105090119593363464568858268074382723204344819</span>, <span class="number">65537</span>)</span><br><span class="line">enc2 = <span class="number">30332590230153809507216298771130058954523332140754441956121305005101434036857592445870499808003492282406658682811671092885592290410570348283122359319554197485624784590315564056341976355615543224373344781813890901916269854242660708815123152440620383035798542275833361820196294814385622613621016771854846491244</span></span><br><span class="line"></span><br><span class="line">V = hints[:<span class="number">4</span>]</span><br><span class="line">k = <span class="number">2</span>^<span class="number">800</span></span><br><span class="line">M = Matrix.column([k * v <span class="keyword">for</span> v <span class="keyword">in</span> V]).augment(Matrix.identity(<span class="built_in">len</span>(V)))</span><br><span class="line">B = [b[<span class="number">1</span>:] <span class="keyword">for</span> b <span class="keyword">in</span> M.LLL()]</span><br><span class="line">M = (k * Matrix(B[:<span class="built_in">len</span>(V)-<span class="number">2</span>])).T.augment(Matrix.identity(<span class="built_in">len</span>(V)))</span><br><span class="line">B = [b[-<span class="built_in">len</span>(V):] <span class="keyword">for</span> b <span class="keyword">in</span> M.LLL() <span class="keyword">if</span> <span class="built_in">set</span>(b[:<span class="built_in">len</span>(V)-<span class="number">2</span>]) == &#123;<span class="number">0</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> s, t <span class="keyword">in</span> itertools.product(<span class="built_in">range</span>(<span class="number">4</span>), repeat=<span class="number">2</span>):</span><br><span class="line">    T = s*B[<span class="number">0</span>] + t*B[<span class="number">1</span>]</span><br><span class="line">    a1, a2, a3, a4 = T</span><br><span class="line">    kq = gcd(a1 * hints[<span class="number">1</span>] - a2 * hints[<span class="number">0</span>], n)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">1</span> &lt; kq &lt; n:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;find!&#x27;</span>, kq, s, t)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">16</span>, <span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> kq % i == <span class="number">0</span>:</span><br><span class="line">        kq //= i</span><br><span class="line">q = <span class="built_in">int</span>(kq)</span><br><span class="line">p = <span class="built_in">int</span>(n // kq)</span><br><span class="line">d = <span class="built_in">pow</span>(<span class="number">0x10001</span>, -<span class="number">1</span>, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">m = <span class="built_in">pow</span>(enc2, d, n)</span><br><span class="line">flag = long_to_bytes(m).decode()</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line">enc3 = <span class="number">17737974772490835017139672507261082238806983528533357501033270577311227414618940490226102450232473366793815933753927943027643033829459416623683596533955075569578787574561297243060958714055785089716571943663350360324047532058597960949979894090400134473940587235634842078030727691627400903239810993936770281755</span></span><br><span class="line">flag = long_to_bytes(<span class="built_in">pow</span>(enc3,d,n)).decode()</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># flag&#123;yOu_can_s0lve_the_@pbq_prob1em!!&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="stage3——unsolved"><a href="#stage3——unsolved" class="headerlink" title="stage3——unsolved"></a>stage3——unsolved</h2><p>比赛的时候第三部分参数和第二部分一样，直接拿第二部分的私钥解密enc3即可。</p>
<p>赛后找到<a target="_blank" rel="noopener" href="https://github.com/defund/ctf/blob/master/angstromctf-2024/blahaj/solve.sage">ctf&#x2F;angstromctf-2024&#x2F;blahaj&#x2F;solve.sage at master · defund&#x2F;ctf</a></p>
<p>原题代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">p = random_prime(<span class="number">2</span>**<span class="number">1024</span>)</span><br><span class="line">q = random_prime(<span class="number">2</span>**<span class="number">1024</span>)</span><br><span class="line">a = randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">1024</span>)</span><br><span class="line">b = randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_flag</span>(<span class="params">file=<span class="string">&#x27;flag.txt&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fin:</span><br><span class="line">        flag = fin.read()</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pad_flag</span>(<span class="params">flag, bits=<span class="number">1024</span></span>):</span><br><span class="line">    pad = os.urandom(bits//<span class="number">8</span> - <span class="built_in">len</span>(flag))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(flag + pad, <span class="string">&quot;big&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_keys</span>(<span class="params">p, q</span>):</span><br><span class="line">    n = p * q</span><br><span class="line">    e = <span class="number">0x10001</span></span><br><span class="line">    <span class="keyword">return</span> n, e</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_message</span>(<span class="params">m, e, n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(m, e, n)</span><br><span class="line"></span><br><span class="line">flag = read_flag()</span><br><span class="line">m = pad_flag(flag)</span><br><span class="line"></span><br><span class="line">n, e = generate_keys(p, q)</span><br><span class="line"><span class="keyword">assert</span> m &lt; n</span><br><span class="line"></span><br><span class="line">c = encrypt_message(m, e, n)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c)</span><br><span class="line"><span class="built_in">print</span>(n)</span><br><span class="line"><span class="built_in">print</span>(p + b * q)</span><br><span class="line"><span class="built_in">print</span>(a * p + q)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>exp</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">68510878638370415044742935889020774276546916983689799210290582093686515377232591362560941306242501220803210859757512468762736941602749345887425082831572206675493389611203432014126644550502117937044804472954180498370676609819898980996282130652627551615825721459553747074503843556784456297882411861526590080037</span></span><br><span class="line">y = <span class="number">117882651978564762717266768251008799169262849451887398128580060795377656792158234083843539818050019451797822782621312362313232759168181582387488893534974006037142066091872636582259199644094998729866484138566711846974126209431468102938252566414322631620261045488855395390985797791782549179665864885691057222752</span></span><br><span class="line">n = <span class="number">94789409892878223843496496113047481402435455468813255092840207010463661854593919772268992045955100688692872116996741724352837555794276141314552518390800907711192442516993891316013640874154318671978150702691578926912235318405120588096104222702992868492960182477857526176600665556671704106974346372234964363581</span></span><br><span class="line">c = <span class="number">17737974772490835017139672507261082238806983528533357501033270577311227414618940490226102450232473366793815933753927943027643033829459416623683596533955075569578787574561297243060958714055785089716571943663350360324047532058597960949979894090400134473940587235634842078030727691627400903239810993936770281755</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">R = Integers(n)</span><br><span class="line">P.&lt;a, b, p, q&gt; = PolynomialRing(Integers(n))</span><br><span class="line">f1 = a*p + q</span><br><span class="line">f2 = p + b*q</span><br><span class="line">f3 = p*q</span><br><span class="line">I = Ideal([f1 - x, f2 - y, f3 - n])</span><br><span class="line">B = I.groebner_basis()</span><br><span class="line"></span><br><span class="line">g = B[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">z = ZZ(g.coefficient(&#123;q: <span class="number">1</span>&#125;))</span><br><span class="line"><span class="keyword">assert</span> g.constant_coefficient() == R(-y)</span><br><span class="line"></span><br><span class="line">_, (z1, _), (z2, _) = <span class="built_in">list</span>(g)</span><br><span class="line">z1 = ZZ(z1)</span><br><span class="line">z2 = ZZ(z2)</span><br><span class="line"></span><br><span class="line">S = <span class="number">2</span>^<span class="number">1024</span></span><br><span class="line"><span class="keyword">for</span> p_upper_bits <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">	p_upper = p_upper_bits &lt;&lt; <span class="number">1020</span></span><br><span class="line">	<span class="keyword">for</span> q_upper_bits <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">		q_upper = q_upper_bits &lt;&lt; <span class="number">1020</span></span><br><span class="line">		M = matrix(ZZ, [[S, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>], [S*z1, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">0</span>], [S*(z2 + p_upper + q_upper*z1), <span class="number">0</span>, <span class="number">0</span>, S], [S*n, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])</span><br><span class="line">		B = M.LLL()</span><br><span class="line">		<span class="keyword">for</span> b <span class="keyword">in</span> B:</span><br><span class="line">			<span class="keyword">if</span> b[-<span class="number">1</span>] == S:</span><br><span class="line">				<span class="keyword">if</span> b[<span class="number">1</span>] &lt; <span class="number">0</span>:</span><br><span class="line">					b *= -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">				p_guess = b[<span class="number">1</span>] + p_upper</span><br><span class="line">				q_guess = b[<span class="number">2</span>] + q_upper</span><br><span class="line">				<span class="keyword">if</span> p_guess * q_guess == n:</span><br><span class="line">					d = <span class="built_in">pow</span>(e, -<span class="number">1</span>, (p_guess - <span class="number">1</span>)*(q_guess - <span class="number">1</span>))</span><br><span class="line">					<span class="built_in">print</span>(<span class="built_in">int</span>(<span class="built_in">pow</span>(c, d, n)).to_bytes(<span class="number">1024</span>//<span class="number">8</span>, <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">					exit()</span><br></pre></td></tr></table></figure>

<p>没打出来</p>
<h1 id="21-steps"><a href="#21-steps" class="headerlink" title="21_steps"></a>21_steps</h1><p>问GPT如何用python在21步内计算128bit值的汉明重量，得到</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hamming_weight</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="comment"># 1. 分离每一位和其邻位，并相加（每2位一组）</span></span><br><span class="line">    x = x - ((x &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555555555555555555555555555</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 将每4位一组中的前2位和后2位相加</span></span><br><span class="line">    x = (x &amp; <span class="number">0x33333333333333333333333333333333</span>) + ((x &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333333333333333333333333333</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 将每8位一组中的前4位和后4位相加</span></span><br><span class="line">    x = (x + (x &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. 将每16位一组中的前8位和后8位相加</span></span><br><span class="line">    x = (x * <span class="number">0x01010101010101010101010101010101</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 5. 将所有累加的结果移到最低位，并提取结果</span></span><br><span class="line">    <span class="keyword">return</span> (x &gt;&gt; <span class="number">120</span>) &amp; <span class="number">0x7F</span>  <span class="comment"># 最高7位足以表示128的汉明权重</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">binary_number = <span class="number">0b110101011011011011011111000110110111011111010111011110110111101101111111110111011111011111010101011101010110101010</span></span><br><span class="line"><span class="built_in">print</span>(hamming_weight(binary_number))</span><br></pre></td></tr></table></figure>

<p>然后一步一步改成符合正则的式子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">B=A&gt;&gt;1;</span><br><span class="line">B=B&amp;113427455640312821154458202477256070485;</span><br><span class="line">A=A-B;</span><br><span class="line"><span class="comment"># 实现x = x - ((x &gt;&gt; 1) &amp; 0x55555555555555555555555555555555)</span></span><br><span class="line">B=A&gt;&gt;2;</span><br><span class="line">B=B&amp;68056473384187692692674921486353642291;</span><br><span class="line">A=A&amp;68056473384187692692674921486353642291;</span><br><span class="line">A=A+B;</span><br><span class="line"><span class="comment"># 实现x = (x &amp; 0x33333333333333333333333333333333) + ((x &gt;&gt; 2) &amp; 0x33333333333333333333333333333333)</span></span><br><span class="line">B=A&gt;&gt;4;</span><br><span class="line">A=A+B;</span><br><span class="line">A=A&amp;20016609818878733144904388672456953615;</span><br><span class="line"><span class="comment"># 实现x = (x + (x &gt;&gt; 4)) &amp; 0x0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F</span></span><br><span class="line">B=A*1334440654591915542993625911497130241;</span><br><span class="line">A=B&amp;340282366920938463463374607431768211455;</span><br><span class="line"><span class="comment"># 实现x = (x * 0x01010101010101010101010101010101) &amp; 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span></span><br><span class="line">B=A&gt;&gt;120;</span><br><span class="line">A=B&amp;127;</span><br></pre></td></tr></table></figure>

<p>一步一步检查是否正确</p>
<blockquote>
<p>test.py</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hamming_weight</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="comment"># 1. 分离每一位和其邻位，并相加（每2位一组）</span></span><br><span class="line">    x = x - ((x &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555555555555555555555555555</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;x1=<span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 2. 将每4位一组中的前2位和后2位相加</span></span><br><span class="line">    x = (x &amp; <span class="number">0x33333333333333333333333333333333</span>) + ((x &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333333333333333333333333333</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;x2=<span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 3. 将每8位一组中的前4位和后4位相加</span></span><br><span class="line">    x = (x + (x &gt;&gt; <span class="number">4</span>)) &amp; <span class="number">0x0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;x3=<span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 4. 将每16位一组中的前8位和后8位相加</span></span><br><span class="line">    x = (x * <span class="number">0x01010101010101010101010101010101</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;x4=<span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 5. 将所有累加的结果移到最低位，并提取结果</span></span><br><span class="line">    <span class="keyword">return</span> (x &gt;&gt; <span class="number">120</span>) &amp; <span class="number">0x7F</span>  <span class="comment"># 最高7位足以表示128的汉明权重</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">binary_number = random.getrandbits(<span class="number">128</span>)</span><br><span class="line"><span class="built_in">print</span>(hamming_weight(binary_number))</span><br><span class="line"></span><br><span class="line">A=<span class="number">0b110101011011011011011111000110110111011111010111011110110111101101111111110111011111011111010101011101010110101010</span></span><br><span class="line">B=A&gt;&gt;<span class="number">1</span></span><br><span class="line">B=B&amp;<span class="number">113427455640312821154458202477256070485</span></span><br><span class="line">A=A-B</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;A1=<span class="subst">&#123;A&#125;</span>&quot;</span>)</span><br><span class="line">B=A&gt;&gt;<span class="number">2</span></span><br><span class="line">B=B&amp;<span class="number">68056473384187692692674921486353642291</span></span><br><span class="line">A=A&amp;<span class="number">68056473384187692692674921486353642291</span></span><br><span class="line">A=A+B</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;A2=<span class="subst">&#123;A&#125;</span>&quot;</span>)</span><br><span class="line">B=A&gt;&gt;<span class="number">4</span></span><br><span class="line">A=A+B</span><br><span class="line">A=A&amp;<span class="number">20016609818878733144904388672456953615</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;A3=<span class="subst">&#123;A&#125;</span>&quot;</span>)</span><br><span class="line">B=A*<span class="number">1334440654591915542993625911497130241</span></span><br><span class="line">A=B&amp;<span class="number">340282366920938463463374607431768211455</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;A4=<span class="subst">&#123;A&#125;</span>&quot;</span>)</span><br><span class="line">B=A&gt;&gt;<span class="number">120</span>;A=B&amp;<span class="number">127</span></span><br><span class="line"><span class="built_in">print</span>(A)</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-1.png"></p>
<p>最后传</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B=A&gt;&gt;1;B=B&amp;113427455640312821154458202477256070485;A=A-B;B=A&gt;&gt;2;B=B&amp;68056473384187692692674921486353642291;A=A&amp;68056473384187692692674921486353642291;A=A+B;B=A&gt;&gt;4;A=A+B;A=A&amp;20016609818878733144904388672456953615;B=A*1334440654591915542993625911497130241;A=B&amp;340282366920938463463374607431768211455;B=A&gt;&gt;120;A=B&amp;127;</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-2.png"></p>
<h1 id="traditional-game"><a href="#traditional-game" class="headerlink" title="traditional_game"></a>traditional_game</h1><h2 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h2><p>同时开两个靶机sh1和sh2，大概率使得seed一样，这样在sh1中一直输入1，如果错误的话，sh2就输入0，反之输入1</p>
<h2 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h2><p>尝试：</p>
<p>d_的生成原理是，先把d的高659位整除blind，最后加上<code>(d % blind)</code>，那么我记准确的高659位为$d_h$，实际上我们得到的是$d_h’$，其中<code>dh&#39; = d_ &gt;&gt; unknown_bit</code>。并且<br>$$<br>d_h &#x3D; d_h’ + x<br>$$<br>这个x的值和blind同数量级</p>
<p>$$<br>d &#x3D; ((d_h’+ x)\times 2^{365} + y)\times blind + d_l<br>$$<br>取<code>dh = d_ &gt;&gt; 365</code></p>
<p>$$<br>d &#x3D; d_h\times 2^{365} + d_x\times blind + d_l<br>$$</p>
<p>$$<br>e[((d_h’ + x)\times 2^{365} + y)\times blind + d_l] &#x3D; 1 + k[(n+1)-(p+q)]<br>$$</p>
<p>于是有<br>$$<br>(ed_h’\times 2^{365}\times blind) + (ex\times2^{365} + y)\times blind + ed_l &#x3D; 1 + k[(n+1)-(p+q)]<br>$$<br>k可以用这个式子计算得到，$k &#x3D; \frac{ed_h\times 2^{365}}{n} + 1$</p>
<p>在模$ed_h\times 2^{365}\times blind$下建立多项式<br>$$<br>f &#x3D; 1 + k[(n+1) - z] - ed_l - (ex\times 2^{365} + y)\times blind \mod (ed_h’\times 2^{365}\times blind)<br>$$<br>无果</p>
<p>正解：根据论文：<a target="_blank" rel="noopener" href="https://cic.iacr.org/p/1/3/29/pdf">Small Public Exponent Brings More: Improved Partial Key Exposure Attacks against RSA</a></p>
<p><img src="/../../images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-4.png"></p>
<p>根据论文一步一步实现攻击即可</p>
<p>第一步是计算$k$，我用$k &#x3D; \frac{e\times d_h}{n} + 1$计算，经检验是准确的。</p>
<p>第二步拿dh，前面就拿了</p>
<p>第三步是恢复p的高位。根据论文中，先令$S &#x3D; N + 1 - \frac{(e\times d_h)}{k}$，$D &#x3D; \sqrt{S^2 - 4n}$，计算$p_h &#x3D; \frac{S + D}{2}$，这样得到的高位大概有105位正确</p>
<p>第四步是求$p \mod blind$，根据式子$ed_l \equiv 1 + k(n+1 - p- q) \mod blind$，这里可以计算出$p + q \equiv k^{-1}(1 + k(n + 1) - ed_l) \mod blind$，记<code>s = p+q</code>，然后解一元二次方程:$x^2 - sx + n \mod blind$，得到$p \mod blind$的值</p>
<p>第五步是求$p \mod e$，和上面的思路一样</p>
<p>第六步分解n</p>
<p>我们现在有<br>$$<br>p_1 \equiv p \mod e<br>$$</p>
<p>$$<br>p_2 \equiv p \mod blind<br>$$</p>
<p>用中国剩余定理求$p_l \equiv p \mod e\times blind$</p>
<p>然后看作$p &#x3D; t\times (e\times blind) + p_l$，这个t可以用$t_0 &#x3D; \frac{p_h - p_l)}{e\times blind}$来近似，那么就有$p &#x3D; (t_0 + x)\times (e\times blind) + p_l$，这个x的差值差不多是240-245bit左右</p>
<p>用coppersmith求小根</p>
<blockquote>
<p>exp.sage</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh1 = remote(<span class="string">&quot;&quot;</span>,)</span><br><span class="line">sh2 = remote(<span class="string">&quot;&quot;</span>,)</span><br><span class="line"></span><br><span class="line">sh1.recvuntil(<span class="string">b&quot;[+] Welcome to the game!&quot;</span>)</span><br><span class="line">sh2.recvuntil(<span class="string">b&quot;[+] Welcome to the game!&quot;</span>)</span><br><span class="line">sh1.recvuntil(<span class="string">b&quot;[+] rsa public key:&quot;</span>)</span><br><span class="line">sh2.recvuntil(<span class="string">b&quot;[+] rsa public key:&quot;</span>)</span><br><span class="line">public_key = <span class="built_in">eval</span>(sh2.recvline().strip().decode())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    sh1.recvuntil(<span class="string">b&quot;[-] b:&quot;</span>)</span><br><span class="line">    sh1.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    sh2.recvuntil(<span class="string">b&quot;[-] b:&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&quot;wrong!&quot;</span> <span class="keyword">in</span> sh1.recvline().strip():</span><br><span class="line">        sh2.sendline(<span class="string">b&quot;0&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(sh2.recvline().strip())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh2.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(sh2.recvline().strip())</span><br><span class="line"></span><br><span class="line">blind_bit = <span class="number">40</span></span><br><span class="line">unknown_bit = <span class="number">365</span></span><br><span class="line">n,e = public_key</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;n = <span class="subst">&#123;n&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;e = <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">sh2.recvuntil(<span class="string">b&quot;privkey is:&quot;</span>)</span><br><span class="line">d_,blind = <span class="built_in">eval</span>(sh2.recvline().strip().decode()[:-<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;d_ = <span class="subst">&#123;d_&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;blind = <span class="subst">&#123;blind&#125;</span>&quot;</span>)</span><br><span class="line">sh2.recvuntil(<span class="string">b&quot;encrypt token is:&quot;</span>)</span><br><span class="line">c = <span class="built_in">eval</span>(sh2.recvline().strip().decode())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;c = <span class="subst">&#123;c&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">dh = d_ &gt;&gt; (unknown_bit + blind_bit) &lt;&lt; (unknown_bit + blind_bit)</span><br><span class="line">dl = d_ % blind</span><br><span class="line"></span><br><span class="line"><span class="comment"># step1 calculate k</span></span><br><span class="line">k = (e*dh) // n + <span class="number">1</span></span><br><span class="line"><span class="comment"># step2 dh</span></span><br><span class="line"><span class="comment"># step3 recover the MSBs of p</span></span><br><span class="line">S = n + <span class="number">1</span> - ((e*dh - <span class="number">1</span>) // k)</span><br><span class="line">D = gmpy2.iroot(<span class="built_in">abs</span>(S**<span class="number">2</span> - <span class="number">4</span>*n),<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">ph = <span class="built_in">int</span>((S + D) // <span class="number">2</span>) &gt;&gt; (<span class="number">512</span> - <span class="number">105</span>) &lt;&lt; (<span class="number">512</span> - <span class="number">105</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step4 calculate p+q % blind</span></span><br><span class="line">s = inverse(k,blind) * (<span class="number">1</span> + k * (n+<span class="number">1</span>) - e*dl) % blind</span><br><span class="line">R.&lt;x&gt; = PolynomialRing(Zmod(blind))</span><br><span class="line">f = x^<span class="number">2</span> - s*x + n</span><br><span class="line">res = f.roots()</span><br><span class="line">may_p_mod_blind = [<span class="built_in">int</span>(res[<span class="number">0</span>][<span class="number">0</span>]),<span class="built_in">int</span>(res[<span class="number">1</span>][<span class="number">0</span>])]</span><br><span class="line"></span><br><span class="line"><span class="comment"># step5 calculate p+q % e</span></span><br><span class="line">k_inv = inverse(k,e)</span><br><span class="line">s = (n + <span class="number">1</span> + k_inv) % e</span><br><span class="line"></span><br><span class="line"><span class="comment"># step6 factor n</span></span><br><span class="line">R.&lt;x&gt; = PolynomialRing(Zmod(e))</span><br><span class="line">f = x^<span class="number">2</span> - s*x + n</span><br><span class="line">res = f.roots()</span><br><span class="line">may_p_mod_e = [<span class="built_in">int</span>(res[<span class="number">0</span>][<span class="number">0</span>]),<span class="built_in">int</span>(res[<span class="number">1</span>][<span class="number">0</span>])]</span><br><span class="line">moduls = <span class="built_in">int</span>(blind) * <span class="built_in">int</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p_mod_e <span class="keyword">in</span> may_p_mod_e:</span><br><span class="line">    <span class="keyword">for</span> p_mod_blind <span class="keyword">in</span> may_p_mod_blind:</span><br><span class="line">        pl = crt([p_mod_blind,p_mod_e],[blind,e])</span><br><span class="line">        th = (ph - pl) // moduls</span><br><span class="line">        PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">        f = (th + x) * moduls + pl</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> trange(<span class="number">240</span>, <span class="number">246</span>):</span><br><span class="line">            roots = f.monic().small_roots(X=<span class="number">2</span>^i,beta=<span class="number">0.49</span>,epsilon=<span class="number">0.02</span>)</span><br><span class="line">            <span class="keyword">if</span> roots != []:</span><br><span class="line">                p = <span class="built_in">int</span>(f(roots[<span class="number">0</span>]))</span><br><span class="line">                <span class="keyword">if</span> n % p == <span class="number">0</span>:</span><br><span class="line">                    <span class="built_in">print</span>(p)</span><br><span class="line">                    q = n // p</span><br><span class="line">                    d = inverse(e,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line">                    m = <span class="built_in">pow</span>(c,d,n)</span><br><span class="line">                    msg = long_to_bytes(m)</span><br><span class="line">                    <span class="built_in">print</span>(msg.<span class="built_in">hex</span>())</span><br><span class="line">                    sh2.sendlineafter(<span class="string">b&quot;[-] guess token:&quot;</span>,msg.<span class="built_in">hex</span>())</span><br><span class="line">                    <span class="built_in">print</span>(sh2.recvline())</span><br><span class="line">                    <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src="/../../images/%E7%AC%AC%E5%9B%9B%E5%B1%8A%E7%BD%91%E9%BC%8E%E6%9D%AF/11-3-3.png"></p>

    </div>

    
    
    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------已经到底啦！<i class="fa fa-paw"></i>-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>DexterJie
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://dexterjie.github.io/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/" title="2024强网杯">https://dexterjie.github.io/2024/11/04/赛题复现/2024强网杯/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Wp/" rel="tag"># Wp</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/10/31/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/%E7%BD%91%E9%BC%8E%E6%9D%AF%20and%20%E5%BC%BA%E7%BD%91%E6%9D%AF/" rel="prev" title="2024网鼎杯">
                  <i class="fa fa-chevron-left"></i> 2024网鼎杯
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">DexterJie</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">284k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">17:13</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>-->


    </div>
  </footer>

  

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  
<div class="busuanzi-count">
  <script async src="/js/busuanzi.pure.mini.js"></script>
  
  <span class="site-uv" title="总访客量">
    访客量<span id="busuanzi_value_site_uv"></span>
  </span>

  <span class="site-pv" title="总访问量">
    经过<span id="busuanzi_value_site_pv"></span>次回眸与你相遇
  </span>
</div>



  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"waline-five-mocha.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"locale":null,"placeholder":"请文明评论呀","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":false,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2024/11/04/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024%E5%BC%BA%E7%BD%91%E6%9D%AF/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right"},"mobile":{"show":true}});</script></body>

</html>
